name: Java CI Pipeline

on:
  push:
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repository
      - name: Checkout
        uses: actions/checkout@v4

      # 2. Set up Java 17
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      # 3. Make mvnw executable (for Linux runners)
      - name: Make mvnw executable
        run: chmod +x mvnw

      # 4. Clean, test, and package the app
      - name: Build with Maven (clean, test, package)
        run: ./mvnw clean test package -DskipTests=false

      # 5. Upload JAR artifact (use v4!)
      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: demo-jar
          path: target/*.jar
          if-no-files-found: error

      # 6. DISCORD NOTIFICATION - ADD THIS STEP
      - name: Discord Notification
        if: always()  # Send notification for both success and failure
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            TITLE="‚úÖ Build Successful!"
            COLOR="3066993"  # Green
            DESCRIPTION="All tests passed! JAR file is ready for download."
          else
            TITLE="‚ùå Build Failed"
            COLOR="15158332"  # Red
            DESCRIPTION="Check GitHub Actions logs for details."
          fi
          
          curl -X POST \
            -H "Content-Type: application/json" \
            -d "{
              \"embeds\": [{
                \"title\": \"$TITLE\",
                \"description\": \"**Repository:** ${{ github.repository }}\\n**Branch:** ${{ github.ref_name }}\\n**Triggered by:** ${{ github.actor }}\\n**Status:** ${{ job.status }}\\n\\n$DESCRIPTION\",
                \"color\": $COLOR,
                \"fields\": [
                  {
                    \"name\": \"üîó View Results\",
                    \"value\": \"[Click here](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\",
                    \"inline\": true
                  },
                  {
                    \"name\": \"üì¶ Artifact\",
                    \"value\": \"JAR file available\",
                    \"inline\": true
                  }
                ],
                \"footer\": {
                  \"text\": \"GitHub Actions ‚Ä¢ $(date -u +'%Y-%m-%d %H:%M:%S UTC')\"
                }
              }]
            }" \
            "${{ secrets.DISCORD_WEBHOOK_URL }}"